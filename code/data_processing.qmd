---
title: "Data processing"
author: "Xiaojing Ni"
format:
    html:
        embed-resources: true
        theme: default
        code-copy: true
        code-fold: true
        code-line-numbers: true
        toc: true
        toc-depth: 4
        link-external-icon: true
        link-external-newwindow: true
---


# Plot data
## Daily average consumption by household
1. Read data
```{r}
## read data

## plug 04 household
## Measurement period:
## 27.06.12 to 23.01.13

## 01: Fridge (no. days: 194, coverage: 97.01%)
## 02: Kitchen appliances (no. days: 194, coverage: 96.81%) (*)
## 03: Lamp (no. days: 170, coverage: 93.54%) (**)
## 04: Stereo and laptop (no. days: 169, coverage: 90.98%)
## 05: Freezer (no. days: 192, coverage: 93.08%)
## 06: Tablet (no. days: 189, coverage: 93.6%)
## 07: Entertainment (no. days: 186, coverage: 94.69%) (***)
## 08: Microwave (no. days: 194, coverage: 97.08%)

appliance <- c("01", "02", "03", "04", "05", "06", "07", "08")
for (a in appliance) {
  file_list <-
    list.files(
      path = paste0("../../eco/04_plug/", a),
      pattern = ".csv",
      all.files = FALSE,
      full.names = FALSE
    )
  
  ## initiate variable name for each applicance
  df_name <- paste0("p04_", a)
  
  for (file in file_list) {
    path <- paste0("../../eco/04_plug/", a, "/", file)
    
    # if the merged dataset doesn't exist, create it
    if (!exists(df_name)) {
      temp <- read.table(path, header = FALSE)
      colnames(temp) <- substr(file, 1, 10)
      assign(df_name, temp)
      rm(temp)
      next
    }
    
    # if the merged dataset does exist, append to it
    if (exists(df_name)) {
      temp_dataset <- read.table(path, header = FALSE)
      colnames(temp_dataset) <- substr(file, 1, 10)
      temp <- cbind(get(df_name), temp_dataset)
      assign(df_name, temp)
      rm(temp_dataset, temp)
    }
  }
}

## read data

## plug 05 household
# Measurement period:
# 27.06.12 to 31.01.13
#
# 01: Tablet (no. days: 218, coverage: 97.87%)
# 02: Coffee machine (no. days: 218, coverage: 95.16%)
# 03: Fountain (no. days: 71, coverage: 99.43%) (*)
# 04: Microwave (no. days: 218, coverage: 97.87%)
# 05: Fridge (no. days: 218, coverage: 97.87%)
# 06: Entertainment (no. days: 192, coverage: 89.14%) (**)
# 07: PC (no. days: 218, coverage: 97.87%) (***)
# 08: Kettle (no. days: 25, coverage: 76.64%)

appliance <- c("01", "02", "03", "04", "05", "06", "07", "08")
for (a in appliance) {
  file_list <-
    list.files(
      path = paste0("../../eco/05_plug/", a),
      pattern = ".csv",
      all.files = FALSE,
      full.names = FALSE
    )
  
  ## initiate variable name for each applicance
  df_name <- paste0("p05_", a)
  
  for (file in file_list) {
    path <- paste0("../../eco/05_plug/", a, "/", file)
    
    # if the merged dataset doesn't exist, create it
    if (!exists(df_name)) {
      temp <- read.table(path, header = FALSE)
      colnames(temp) <- substr(file, 1, 10)
      assign(df_name, temp)
      rm(temp)
      next
    }
    
    # if the merged dataset does exist, append to it
    if (exists(df_name)) {
      temp_dataset <- read.table(path, header = FALSE)
      colnames(temp_dataset) <- substr(file, 1, 10)
      temp <- cbind(get(df_name), temp_dataset)
      assign(df_name, temp)
      rm(temp_dataset, temp)
    }
  }
}

## read data

## plug 06 household
# PLUG DATA
# ---------
#
# Measurement period:
# 27.06.12 to 31.01.13
#
# 01: Lamp (no. days: 166, coverage: 67.2%)
# 02: Laptop (no. days: 185, coverage: 97.3%) (*)
# 03: Router (no. days: 88, coverage: 96.73%) (**)
# 04: Coffee machine (no. days: 179, coverage: 86.03%)
# 05: Entertainment (no. days: 181, coverage: 95.86%) (***)
# 06: Fridge (no. days: 179, coverage: 95.78%)
# 07: Kettle (no. days: 147, coverage: 82.54%)

appliance <- c("01", "02", "03", "04", "05", "06", "07")
for (a in appliance) {
  file_list <-
    list.files(
      path = paste0("../../eco/06_plug/", a),
      pattern = ".csv",
      all.files = FALSE,
      full.names = FALSE
    )
  
  ## initiate variable name for each applicance
  df_name <- paste0("p06_", a)
  
  for (file in file_list) {
    path <- paste0("../../eco/06_plug/", a, "/", file)
    
    # if the merged dataset doesn't exist, create it
    if (!exists(df_name)) {
      temp <- read.table(path, header = FALSE)
      colnames(temp) <- substr(file, 1, 10)
      assign(df_name, temp)
      rm(temp)
      next
    }
    
    # if the merged dataset does exist, append to it
    if (exists(df_name)) {
      temp_dataset <- read.table(path, header = FALSE)
      colnames(temp_dataset) <- substr(file, 1, 10)
      temp <- cbind(get(df_name), temp_dataset)
      assign(df_name, temp)
      rm(temp_dataset, temp)
    }
  }
}
```
2. Replace negative values (missing values) as NA
```{r}
households <- c("04", "05", "06")
appliance <- c("01", "02", "03", "04", "05", "06", "07", "08")

for (household in households) {
  for (a in appliance) {
    if (!(household == "06" && a == "08")) {
      df <- get(paste0("p", household, "_", a))
      df <- replace(df, df < 0, NA)
      assign(paste0("p", household, "_", a),df)
    }
    
  }
}
```
3. Compute daily consumption by each household and each appliance. 
```{r}

daily_consum <- function(household) {
  for (a in appliance) {
    if (household != "06") {
      df <- get(paste0("p", household, "_", a))
      hour_avg <-
        rowMeans(aggregate(
          df,
          list(rep(
            1:(nrow(p04_01) %/% 3600 + 1),
            each = 3600,
            len = nrow(df)
          )),
          sum,
          na.rm = TRUE,
          na.action = NULL
        )[-1])
      daily_avg <- mean(colMeans(df))
      
      daily_power <- data.frame(
        household = rep(household, 24),
        daily_avg = rep(daily_avg, 24),
        appliance = rep(appliance, 24),
        hour = seq.int(24),
        hour_avg = hour_avg
      )
    }
  else {
    if (a != "08") {
    df <- get(paste0("p", household, "_", a))
      hour_avg <-
        rowMeans(aggregate(
          df,
          list(rep(
            1:(nrow(p04_01) %/% 3600 + 1),
            each = 3600,
            len = nrow(df)
          )),
          sum,
          na.rm = TRUE,
          na.action = NULL
        )[-1])
      daily_avg <- mean(colMeans(df))
      
      daily_power <- data.frame(
        household = rep(household, 24),
        daily_avg = rep(daily_avg, 24),
        appliance = rep(appliance[1:7], 24),
        hour = seq.int(24),
        hour_avg = hour_avg
      )
    
  }}}
      return(daily_power)
}

daily_power <-
  bind_rows(lapply(households, daily_consum), .id = "column_label")

```
4. Save the data
```{r}
```
# Smart meter data

## Hourly total consumption (watt * time) for different phase

1. Read data
```{r}
## read data

## 04 household
# SMART METER DATA
# ----------------
#
# Measurement period:
# 27.06.12 to 31.01.13
#
# Coverage:
# No. days: 219, Coverage: 99.39%


file_list <-
  list.files(
    path = paste0("../../eco/04_sm"),
    pattern = ".csv",
    all.files = FALSE,
    full.names = FALSE
  )



for (file in file_list) {
  path <- paste0("../../eco/04_sm/", file)
  
  for (phase in 0:3) {
    # if the merged dataset doesn't exist, create it
    
    ## initiate variable name for each phase
    df_phase <- paste0("s04_", phase)
    
    if (!exists(df_phase)) {
      temp <- read.csv(path, header = FALSE)
      temp <- data.frame(temp[, phase + 1])
      colnames(temp) <- substr(file, 1, 10)
      assign(df_phase, temp)
      rm(temp)
      next
    }
    
    # if the merged dataset does exist, append to it
    if (exists(df_phase)) {
      temp_dataset <- read.csv(path, header = FALSE)
      temp_dataset <- data.frame(temp_dataset[, phase + 1])
      colnames(temp_dataset) <- substr(file, 1, 10)
      temp <- cbind(get(df_phase), temp_dataset)
      assign(df_phase, temp)
      rm(temp_dataset, temp)
    }
  }
}

## 05 household

# SMART METER DATA
# ----------------
# 
# Measurement period:
# 27.06.12 to 31.01.13
# 
# Coverage:
# No. days: 215, Coverage: 99.05%


file_list <-
  list.files(
    path = paste0("../../eco/05_sm"),
    pattern = ".csv",
    all.files = FALSE,
    full.names = FALSE
  )



for (file in file_list) {
  path <- paste0("../../eco/05_sm/", file)
  
  for (phase in 0:3) {
    # if the merged dataset doesn't exist, create it
    
    ## initiate variable name for each phase
    df_phase <- paste0("s05_", phase)
    
    if (!exists(df_phase)) {
      temp <- read.csv(path, header = FALSE)
      temp <- data.frame(temp[, phase + 1])
      colnames(temp) <- substr(file, 1, 10)
      assign(df_phase, temp)
      rm(temp)
      next
    }
    
    # if the merged dataset does exist, append to it
    if (exists(df_phase)) {
      temp_dataset <- read.csv(path, header = FALSE)
      temp_dataset <- data.frame(temp_dataset[, phase + 1])
      colnames(temp_dataset) <- substr(file, 1, 10)
      temp <- cbind(get(df_phase), temp_dataset)
      assign(df_phase, temp)
      rm(temp_dataset, temp)
    }
  }
}

## 06 household

# SMART METER DATA
# ----------------
# 
# Measurement period:
# 27.06.12 to 31.01.13
# 
# Coverage:
# No. days: 166, Coverage: 99.67%


file_list <-
  list.files(
    path = paste0("../../eco/06_sm"),
    pattern = ".csv",
    all.files = FALSE,
    full.names = FALSE
  )



for (file in file_list) {
  path <- paste0("../../eco/06_sm/", file)
  
  for (phase in 0:3) {
    # if the merged dataset doesn't exist, create it
    
    ## initiate variable name for each phase
    df_phase <- paste0("s06_", phase)
    
    if (!exists(df_phase)) {
      temp <- read.csv(path, header = FALSE)
      temp <- data.frame(temp[, phase + 1])
      colnames(temp) <- substr(file, 1, 10)
      assign(df_phase, temp)
      rm(temp)
      next
    }
    
    # if the merged dataset does exist, append to it
    if (exists(df_phase)) {
      temp_dataset <- read.csv(path, header = FALSE)
      temp_dataset <- data.frame(temp_dataset[, phase + 1])
      colnames(temp_dataset) <- substr(file, 1, 10)
      temp <- cbind(get(df_phase), temp_dataset)
      assign(df_phase, temp)
      rm(temp_dataset, temp)
    }
  }
}
```

2. Replace negative values (missing values) as NA
```{r}
households <- c("04", "05", "06")

for (household in households) {
  for (phase in 0:3) {
    df <- get(paste0("s", household, "_", phase))
    df <- replace(df, df < 0, NA)
    assign(paste0("s", household, "_", phase),df)
    
  }
}
```

2. Compute hourly/semi-hourly consumption for each phase, kwh
```{r}
df <- data.frame(c("household","total","phase1","phase2","phase3"))
hour_avg <- colSums(aggregate(s04_0, list(rep(1:(nrow(s04_0) %/% 3600 + 1), each = 3600, len = nrow(p04_01))), sum)[-1])/3600000
```